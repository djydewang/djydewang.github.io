<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><pre><p><a href="#L1">1</a>/*
</p><p><a href="#L2">2</a> * Copyright 2002-2018 the original author or authors.
</p><p><a href="#L3">3</a> *
</p><p><a href="#L4">4</a> * Licensed under the Apache License, Version 2.0 (the "License");
</p><p><a href="#L5">5</a> * you may not use this file except in compliance with the License.
</p><p><a href="#L6">6</a> * You may obtain a copy of the License at
</p><p><a href="#L7">7</a> *
</p><p><a href="#L8">8</a> *      http://www.apache.org/licenses/LICENSE-2.0
</p><p><a href="#L9">9</a> *
</p><p><a href="#L10">10</a> * Unless required by applicable law or agreed to in writing, software
</p><p><a href="#L11">11</a> * distributed under the License is distributed on an "AS IS" BASIS,
</p><p><a href="#L12">12</a> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</p><p><a href="#L13">13</a> * See the License for the specific language governing permissions and
</p><p><a href="#L14">14</a> * limitations under the License.
</p><p><a href="#L15">15</a> */
</p><p><a href="#L16">16</a>
</p><p><a href="#L17">17</a>package org.springframework.test.web.servlet.htmlunit;
</p><p><a href="#L18">18</a>
</p><p><a href="#L19">19</a>import java.io.UnsupportedEncodingException;
</p><p><a href="#L20">20</a>import java.net.URL;
</p><p><a href="#L21">21</a>import java.net.URLDecoder;
</p><p><a href="#L22">22</a>import java.nio.charset.Charset;
</p><p><a href="#L23">23</a>import java.nio.charset.StandardCharsets;
</p><p><a href="#L24">24</a>import java.util.ArrayList;
</p><p><a href="#L25">25</a>import java.util.Enumeration;
</p><p><a href="#L26">26</a>import java.util.List;
</p><p><a href="#L27">27</a>import java.util.Locale;
</p><p><a href="#L28">28</a>import java.util.Map;
</p><p><a href="#L29">29</a>import java.util.Set;
</p><p><a href="#L30">30</a>import java.util.StringTokenizer;
</p><p><a href="#L31">31</a>import javax.servlet.ServletContext;
</p><p><a href="#L32">32</a>import javax.servlet.http.Cookie;
</p><p><a href="#L33">33</a>import javax.servlet.http.HttpServletRequest;
</p><p><a href="#L34">34</a>import javax.servlet.http.HttpSession;
</p><p><a href="#L35">35</a>
</p><p><a href="#L36">36</a>import com.gargoylesoftware.htmlunit.CookieManager;
</p><p><a href="#L37">37</a>import com.gargoylesoftware.htmlunit.FormEncodingType;
</p><p><a href="#L38">38</a>import com.gargoylesoftware.htmlunit.WebClient;
</p><p><a href="#L39">39</a>import com.gargoylesoftware.htmlunit.WebRequest;
</p><p><a href="#L40">40</a>import com.gargoylesoftware.htmlunit.util.NameValuePair;
</p><p><a href="#L41">41</a>
</p><p><a href="#L42">42</a>import org.springframework.beans.Mergeable;
</p><p><a href="#L43">43</a>import org.springframework.http.MediaType;
</p><p><a href="#L44">44</a>import org.springframework.lang.Nullable;
</p><p><a href="#L45">45</a>import org.springframework.mock.web.MockHttpServletRequest;
</p><p><a href="#L46">46</a>import org.springframework.mock.web.MockHttpSession;
</p><p><a href="#L47">47</a>import org.springframework.test.web.servlet.RequestBuilder;
</p><p><a href="#L48">48</a>import org.springframework.test.web.servlet.SmartRequestBuilder;
</p><p><a href="#L49">49</a>import org.springframework.test.web.servlet.request.MockHttpServletRequestBuilder;
</p><p><a href="#L50">50</a>import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;
</p><p><a href="#L51">51</a>import org.springframework.test.web.servlet.request.RequestPostProcessor;
</p><p><a href="#L52">52</a>import org.springframework.util.Assert;
</p><p><a href="#L53">53</a>import org.springframework.util.ObjectUtils;
</p><p><a href="#L54">54</a>import org.springframework.util.StringUtils;
</p><p><a href="#L55">55</a>import org.springframework.web.util.UriComponents;
</p><p><a href="#L56">56</a>import org.springframework.web.util.UriComponentsBuilder;
</p><p><a href="#L57">57</a>
</p><p><a href="#L58">58</a>/**
</p><p><a href="#L59">59</a> * Internal class used to transform a {@link WebRequest} into a
</p><p><a href="#L60">60</a> * {@link MockHttpServletRequest} using Spring MVC Test's {@link RequestBuilder}.
</p><p><a href="#L61">61</a> *
</p><p><a href="#L62">62</a> * &lt;p&gt;By default the first path segment of the URL is used as the context path.
</p><p><a href="#L63">63</a> * To override this default see {@link #setContextPath(String)}.
</p><p><a href="#L64">64</a> *
</p><p><a href="#L65">65</a> * @author Rob Winch
</p><p><a href="#L66">66</a> * @author Sam Brannen
</p><p><a href="#L67">67</a> * @since 4.2
</p><p><a href="#L68">68</a> * @see MockMvcWebConnection
</p><p><a href="#L69">69</a> */
</p><p><a href="#L70">70</a>final class HtmlUnitRequestBuilder implements RequestBuilder, Mergeable {
</p><p><a href="#L71">71</a>
</p><p><a href="#L72">72</a>	private final Map&lt;String, MockHttpSession&gt; sessions;
</p><p><a href="#L73">73</a>
</p><p><a href="#L74">74</a>	private final WebClient webClient;
</p><p><a href="#L75">75</a>
</p><p><a href="#L76">76</a>	private final WebRequest webRequest;
</p><p><a href="#L77">77</a>
</p><p><a href="#L78">78</a>	@Nullable
</p><p><a href="#L79">79</a>	private String contextPath;
</p><p><a href="#L80">80</a>
</p><p><a href="#L81">81</a>	@Nullable
</p><p><a href="#L82">82</a>	private RequestBuilder parentBuilder;
</p><p><a href="#L83">83</a>
</p><p><a href="#L84">84</a>	@Nullable
</p><p><a href="#L85">85</a>	private SmartRequestBuilder parentPostProcessor;
</p><p><a href="#L86">86</a>
</p><p><a href="#L87">87</a>	@Nullable
</p><p><a href="#L88">88</a>	private RequestPostProcessor forwardPostProcessor;
</p><p><a href="#L89">89</a>
</p><p><a href="#L90">90</a>
</p><p><a href="#L91">91</a>	/**
</p><p><a href="#L92">92</a>	 * Construct a new {@code HtmlUnitRequestBuilder}.
</p><p><a href="#L93">93</a>	 * @param sessions a {@link Map} from session {@linkplain HttpSession#getId() IDs}
</p><p><a href="#L94">94</a>	 * to currently managed {@link HttpSession} objects; never {@code null}
</p><p><a href="#L95">95</a>	 * @param webClient the WebClient for retrieving cookies
</p><p><a href="#L96">96</a>	 * @param webRequest the {@link WebRequest} to transform into a
</p><p><a href="#L97">97</a>	 * {@link MockHttpServletRequest}; never {@code null}
</p><p><a href="#L98">98</a>	 */
</p><p><a href="#L99">99</a>	public HtmlUnitRequestBuilder(Map&lt;String, MockHttpSession&gt; sessions, WebClient webClient, WebRequest webRequest) {
</p><p><a href="#L100">100</a>		Assert.notNull(sessions, "Sessions Map must not be null");
</p><p><a href="#L101">101</a>		Assert.notNull(webClient, "WebClient must not be null");
</p><p><a href="#L102">102</a>		Assert.notNull(webRequest, "WebRequest must not be null");
</p><p><a href="#L103">103</a>		this.sessions = sessions;
</p><p><a href="#L104">104</a>		this.webClient = webClient;
</p><p><a href="#L105">105</a>		this.webRequest = webRequest;
</p><p><a href="#L106">106</a>	}
</p><p><a href="#L107">107</a>
</p><p><a href="#L108">108</a>
</p><p><a href="#L109">109</a>	public MockHttpServletRequest buildRequest(ServletContext servletContext) {
</p><p><a href="#L110">110</a>		Charset charset = getCharset();
</p><p><a href="#L111">111</a>		String httpMethod = this.webRequest.getHttpMethod().name();
</p><p><a href="#L112">112</a>		UriComponents uriComponents = uriComponents();
</p><p><a href="#L113">113</a>		String path = uriComponents.getPath();
</p><p><a href="#L114">114</a>
</p><p><a href="#L115">115</a>		MockHttpServletRequest request = new HtmlUnitMockHttpServletRequest(
</p><p><a href="#L116">116</a>				servletContext, httpMethod, (path != null ? path : ""));
</p><p><a href="#L117">117</a>		parent(request, this.parentBuilder);
</p><p><a href="#L118">118</a>		String host = uriComponents.getHost();
</p><p><a href="#L119">119</a>		request.setServerName(host != null ? host : "");  // needs to be first for additional headers
</p><p><a href="#L120">120</a>		authType(request);
</p><p><a href="#L121">121</a>		request.setCharacterEncoding(charset.name());
</p><p><a href="#L122">122</a>		content(request, charset);
</p><p><a href="#L123">123</a>		contextPath(request, uriComponents);
</p><p><a href="#L124">124</a>		contentType(request);
</p><p><a href="#L125">125</a>		cookies(request);
</p><p><a href="#L126">126</a>		headers(request);
</p><p><a href="#L127">127</a>		locales(request);
</p><p><a href="#L128">128</a>		servletPath(uriComponents, request);
</p><p><a href="#L129">129</a>		params(request, uriComponents);
</p><p><a href="#L130">130</a>		ports(uriComponents, request);
</p><p><a href="#L131">131</a>		request.setProtocol("HTTP/1.1");
</p><p><a href="#L132">132</a>		request.setQueryString(uriComponents.getQuery());
</p><p><a href="#L133">133</a>		String scheme = uriComponents.getScheme();
</p><p><a href="#L134">134</a>		request.setScheme(scheme != null ? scheme : "");
</p><p><a href="#L135">135</a>		request.setPathInfo(null);
</p><p><a href="#L136">136</a>
</p><p><a href="#L137">137</a>		return postProcess(request);
</p><p><a href="#L138">138</a>	}
</p><p><a href="#L139">139</a>
</p><p><a href="#L140">140</a>	private Charset getCharset() {
</p><p><a href="#L141">141</a>		Charset charset = this.webRequest.getCharset();
</p><p><a href="#L142">142</a>		return (charset != null ? charset : StandardCharsets.ISO_8859_1);
</p><p><a href="#L143">143</a>	}
</p><p><a href="#L144">144</a>
</p><p><a href="#L145">145</a>	private MockHttpServletRequest postProcess(MockHttpServletRequest request) {
</p><p><a href="#L146">146</a>		if (this.parentPostProcessor != null) {
</p><p><a href="#L147">147</a>			request = this.parentPostProcessor.postProcessRequest(request);
</p><p><a href="#L148">148</a>		}
</p><p><a href="#L149">149</a>		if (this.forwardPostProcessor != null) {
</p><p><a href="#L150">150</a>			request = this.forwardPostProcessor.postProcessRequest(request);
</p><p><a href="#L151">151</a>		}
</p><p><a href="#L152">152</a>		return request;
</p><p><a href="#L153">153</a>	}
</p><p><a href="#L154">154</a>
</p><p><a href="#L155">155</a>	private void parent(MockHttpServletRequest request, @Nullable RequestBuilder parent) {
</p><p><a href="#L156">156</a>		if (parent == null) {
</p><p><a href="#L157">157</a>			return;
</p><p><a href="#L158">158</a>		}
</p><p><a href="#L159">159</a>
</p><p><a href="#L160">160</a>		MockHttpServletRequest parentRequest = parent.buildRequest(request.getServletContext());
</p><p><a href="#L161">161</a>
</p><p><a href="#L162">162</a>		// session
</p><p><a href="#L163">163</a>		HttpSession parentSession = parentRequest.getSession(false);
</p><p><a href="#L164">164</a>		if (parentSession != null) {
</p><p><a href="#L165">165</a>			HttpSession localSession = request.getSession();
</p><p><a href="#L166">166</a>			Assert.state(localSession != null, "No local HttpSession");
</p><p><a href="#L167">167</a>			Enumeration&lt;String&gt; attrNames = parentSession.getAttributeNames();
</p><p><a href="#L168">168</a>			while (attrNames.hasMoreElements()) {
</p><p><a href="#L169">169</a>				String attrName = attrNames.nextElement();
</p><p><a href="#L170">170</a>				Object attrValue = parentSession.getAttribute(attrName);
</p><p><a href="#L171">171</a>				localSession.setAttribute(attrName, attrValue);
</p><p><a href="#L172">172</a>			}
</p><p><a href="#L173">173</a>		}
</p><p><a href="#L174">174</a>
</p><p><a href="#L175">175</a>		// header
</p><p><a href="#L176">176</a>		Enumeration&lt;String&gt; headerNames = parentRequest.getHeaderNames();
</p><p><a href="#L177">177</a>		while (headerNames.hasMoreElements()) {
</p><p><a href="#L178">178</a>			String attrName = headerNames.nextElement();
</p><p><a href="#L179">179</a>			Enumeration&lt;String&gt; attrValues = parentRequest.getHeaders(attrName);
</p><p><a href="#L180">180</a>			while (attrValues.hasMoreElements()) {
</p><p><a href="#L181">181</a>				String attrValue = attrValues.nextElement();
</p><p><a href="#L182">182</a>				request.addHeader(attrName, attrValue);
</p><p><a href="#L183">183</a>			}
</p><p><a href="#L184">184</a>		}
</p><p><a href="#L185">185</a>
</p><p><a href="#L186">186</a>		// parameter
</p><p><a href="#L187">187</a>		Map&lt;String, String[]&gt; parentParams = parentRequest.getParameterMap();
</p><p><a href="#L188">188</a>		parentParams.forEach(request::addParameter);
</p><p><a href="#L189">189</a>
</p><p><a href="#L190">190</a>		// cookie
</p><p><a href="#L191">191</a>		Cookie[] parentCookies = parentRequest.getCookies();
</p><p><a href="#L192">192</a>		if (!ObjectUtils.isEmpty(parentCookies)) {
</p><p><a href="#L193">193</a>			request.setCookies(parentCookies);
</p><p><a href="#L194">194</a>		}
</p><p><a href="#L195">195</a>
</p><p><a href="#L196">196</a>		// request attribute
</p><p><a href="#L197">197</a>		Enumeration&lt;String&gt; parentAttrNames = parentRequest.getAttributeNames();
</p><p><a href="#L198">198</a>		while (parentAttrNames.hasMoreElements()) {
</p><p><a href="#L199">199</a>			String parentAttrName = parentAttrNames.nextElement();
</p><p><a href="#L200">200</a>			request.setAttribute(parentAttrName, parentRequest.getAttribute(parentAttrName));
</p><p><a href="#L201">201</a>		}
</p><p><a href="#L202">202</a>	}
</p><p><a href="#L203">203</a>
</p><p><a href="#L204">204</a>	/**
</p><p><a href="#L205">205</a>	 * Set the contextPath to be used.
</p><p><a href="#L206">206</a>	 * &lt;p&gt;The value may be null in which case the first path segment of the
</p><p><a href="#L207">207</a>	 * URL is turned into the contextPath. Otherwise it must conform to
</p><p><a href="#L208">208</a>	 * {@link HttpServletRequest#getContextPath()} which states it can be
</p><p><a href="#L209">209</a>	 * an empty string, or it must start with a "/" and not end with a "/".
</p><p><a href="#L210">210</a>	 * @param contextPath a valid contextPath
</p><p><a href="#L211">211</a>	 * @throws IllegalArgumentException if the contextPath is not a valid
</p><p><a href="#L212">212</a>	 * {@link HttpServletRequest#getContextPath()}
</p><p><a href="#L213">213</a>	 */
</p><p><a href="#L214">214</a>	public void setContextPath(@Nullable String contextPath) {
</p><p><a href="#L215">215</a>		MockMvcWebConnection.validateContextPath(contextPath);
</p><p><a href="#L216">216</a>		this.contextPath = contextPath;
</p><p><a href="#L217">217</a>	}
</p><p><a href="#L218">218</a>
</p><p><a href="#L219">219</a>	public void setForwardPostProcessor(RequestPostProcessor forwardPostProcessor) {
</p><p><a href="#L220">220</a>		this.forwardPostProcessor = forwardPostProcessor;
</p><p><a href="#L221">221</a>	}
</p><p><a href="#L222">222</a>
</p><p><a href="#L223">223</a>	private void authType(MockHttpServletRequest request) {
</p><p><a href="#L224">224</a>		String authorization = header("Authorization");
</p><p><a href="#L225">225</a>		String[] authSplit = StringUtils.split(authorization, ": ");
</p><p><a href="#L226">226</a>		if (authSplit != null) {
</p><p><a href="#L227">227</a>			request.setAuthType(authSplit[0]);
</p><p><a href="#L228">228</a>		}
</p><p><a href="#L229">229</a>	}
</p><p><a href="#L230">230</a>
</p><p><a href="#L231">231</a>	private void content(MockHttpServletRequest request, Charset charset) {
</p><p><a href="#L232">232</a>		String requestBody = this.webRequest.getRequestBody();
</p><p><a href="#L233">233</a>		if (requestBody == null) {
</p><p><a href="#L234">234</a>			return;
</p><p><a href="#L235">235</a>		}
</p><p><a href="#L236">236</a>		request.setContent(requestBody.getBytes(charset));
</p><p><a href="#L237">237</a>	}
</p><p><a href="#L238">238</a>
</p><p><a href="#L239">239</a>	private void contentType(MockHttpServletRequest request) {
</p><p><a href="#L240">240</a>		String contentType = header("Content-Type");
</p><p><a href="#L241">241</a>		if (contentType == null) {
</p><p><a href="#L242">242</a>			FormEncodingType encodingType = this.webRequest.getEncodingType();
</p><p><a href="#L243">243</a>			if (encodingType != null) {
</p><p><a href="#L244">244</a>				contentType = encodingType.getName();
</p><p><a href="#L245">245</a>			}
</p><p><a href="#L246">246</a>		}
</p><p><a href="#L247">247</a>		request.setContentType(contentType != null ? contentType : MediaType.ALL_VALUE);
</p><p><a href="#L248">248</a>	}
</p><p><a href="#L249">249</a>
</p><p><a href="#L250">250</a>	private void contextPath(MockHttpServletRequest request, UriComponents uriComponents) {
</p><p><a href="#L251">251</a>		if (this.contextPath == null) {
</p><p><a href="#L252">252</a>			List&lt;String&gt; pathSegments = uriComponents.getPathSegments();
</p><p><a href="#L253">253</a>			if (pathSegments.isEmpty()) {
</p><p><a href="#L254">254</a>				request.setContextPath("");
</p><p><a href="#L255">255</a>			}
</p><p><a href="#L256">256</a>			else {
</p><p><a href="#L257">257</a>				request.setContextPath("/" + pathSegments.get(0));
</p><p><a href="#L258">258</a>			}
</p><p><a href="#L259">259</a>		}
</p><p><a href="#L260">260</a>		else {
</p><p><a href="#L261">261</a>			String path = uriComponents.getPath();
</p><p><a href="#L262">262</a>			Assert.isTrue(path != null &amp;&amp; path.startsWith(this.contextPath),
</p><p><a href="#L263">263</a>					() -&gt; "\"" + uriComponents.getPath() +
</p><p><a href="#L264">264</a>							"\" should start with context path \"" + this.contextPath + "\"");
</p><p><a href="#L265">265</a>			request.setContextPath(this.contextPath);
</p><p><a href="#L266">266</a>		}
</p><p><a href="#L267">267</a>	}
</p><p><a href="#L268">268</a>
</p><p><a href="#L269">269</a>	private void cookies(MockHttpServletRequest request) {
</p><p><a href="#L270">270</a>		List&lt;Cookie&gt; cookies = new ArrayList&lt;&gt;();
</p><p><a href="#L271">271</a>
</p><p><a href="#L272">272</a>		String cookieHeaderValue = header("Cookie");
</p><p><a href="#L273">273</a>		if (cookieHeaderValue != null) {
</p><p><a href="#L274">274</a>			StringTokenizer tokens = new StringTokenizer(cookieHeaderValue, "=;");
</p><p><a href="#L275">275</a>			while (tokens.hasMoreTokens()) {
</p><p><a href="#L276">276</a>				String cookieName = tokens.nextToken().trim();
</p><p><a href="#L277">277</a>				Assert.isTrue(tokens.hasMoreTokens(),
</p><p><a href="#L278">278</a>						() -&gt; "Expected value for cookie name '" + cookieName +
</p><p><a href="#L279">279</a>								"': full cookie header was [" + cookieHeaderValue + "]");
</p><p><a href="#L280">280</a>				String cookieValue = tokens.nextToken().trim();
</p><p><a href="#L281">281</a>				processCookie(request, cookies, new Cookie(cookieName, cookieValue));
</p><p><a href="#L282">282</a>			}
</p><p><a href="#L283">283</a>		}
</p><p><a href="#L284">284</a>
</p><p><a href="#L285">285</a>		Set&lt;com.gargoylesoftware.htmlunit.util.Cookie&gt; managedCookies = this.webClient.getCookies(this.webRequest.getUrl());
</p><p><a href="#L286">286</a>		for (com.gargoylesoftware.htmlunit.util.Cookie cookie : managedCookies) {
</p><p><a href="#L287">287</a>			processCookie(request, cookies, new Cookie(cookie.getName(), cookie.getValue()));
</p><p><a href="#L288">288</a>		}
</p><p><a href="#L289">289</a>
</p><p><a href="#L290">290</a>		Cookie[] parentCookies = request.getCookies();
</p><p><a href="#L291">291</a>		if (parentCookies != null) {
</p><p><a href="#L292">292</a>			for (Cookie cookie : parentCookies) {
</p><p><a href="#L293">293</a>				cookies.add(cookie);
</p><p><a href="#L294">294</a>			}
</p><p><a href="#L295">295</a>		}
</p><p><a href="#L296">296</a>
</p><p><a href="#L297">297</a>		if (!ObjectUtils.isEmpty(cookies)) {
</p><p><a href="#L298">298</a>			request.setCookies(cookies.toArray(new Cookie[0]));
</p><p><a href="#L299">299</a>		}
</p><p><a href="#L300">300</a>	}
</p><p><a href="#L301">301</a>
</p><p><a href="#L302">302</a>	private void processCookie(MockHttpServletRequest request, List&lt;Cookie&gt; cookies, Cookie cookie) {
</p><p><a href="#L303">303</a>		cookies.add(cookie);
</p><p><a href="#L304">304</a>		if ("JSESSIONID".equals(cookie.getName())) {
</p><p><a href="#L305">305</a>			request.setRequestedSessionId(cookie.getValue());
</p><p><a href="#L306">306</a>			request.setSession(httpSession(request, cookie.getValue()));
</p><p><a href="#L307">307</a>		}
</p><p><a href="#L308">308</a>	}
</p><p><a href="#L309">309</a>
</p><p><a href="#L310">310</a>	@Nullable
</p><p><a href="#L311">311</a>	private String header(String headerName) {
</p><p><a href="#L312">312</a>		return this.webRequest.getAdditionalHeaders().get(headerName);
</p><p><a href="#L313">313</a>	}
</p><p><a href="#L314">314</a>
</p><p><a href="#L315">315</a>	private void headers(MockHttpServletRequest request) {
</p><p><a href="#L316">316</a>		this.webRequest.getAdditionalHeaders().forEach(request::addHeader);
</p><p><a href="#L317">317</a>	}
</p><p><a href="#L318">318</a>
</p><p><a href="#L319">319</a>	private MockHttpSession httpSession(MockHttpServletRequest request, final String sessionid) {
</p><p><a href="#L320">320</a>		MockHttpSession session;
</p><p><a href="#L321">321</a>		synchronized (this.sessions) {
</p><p><a href="#L322">322</a>			session = this.sessions.get(sessionid);
</p><p><a href="#L323">323</a>			if (session == null) {
</p><p><a href="#L324">324</a>				session = new HtmlUnitMockHttpSession(request, sessionid);
</p><p><a href="#L325">325</a>				session.setNew(true);
</p><p><a href="#L326">326</a>				synchronized (this.sessions) {
</p><p><a href="#L327">327</a>					this.sessions.put(sessionid, session);
</p><p><a href="#L328">328</a>				}
</p><p><a href="#L329">329</a>				addSessionCookie(request, sessionid);
</p><p><a href="#L330">330</a>			}
</p><p><a href="#L331">331</a>			else {
</p><p><a href="#L332">332</a>				session.setNew(false);
</p><p><a href="#L333">333</a>			}
</p><p><a href="#L334">334</a>		}
</p><p><a href="#L335">335</a>		return session;
</p><p><a href="#L336">336</a>	}
</p><p><a href="#L337">337</a>
</p><p><a href="#L338">338</a>	private void addSessionCookie(MockHttpServletRequest request, String sessionid) {
</p><p><a href="#L339">339</a>		getCookieManager().addCookie(createCookie(request, sessionid));
</p><p><a href="#L340">340</a>	}
</p><p><a href="#L341">341</a>
</p><p><a href="#L342">342</a>	private void removeSessionCookie(MockHttpServletRequest request, String sessionid) {
</p><p><a href="#L343">343</a>		getCookieManager().removeCookie(createCookie(request, sessionid));
</p><p><a href="#L344">344</a>	}
</p><p><a href="#L345">345</a>
</p><p><a href="#L346">346</a>	private com.gargoylesoftware.htmlunit.util.Cookie createCookie(MockHttpServletRequest request, String sessionid) {
</p><p><a href="#L347">347</a>		return new com.gargoylesoftware.htmlunit.util.Cookie(request.getServerName(), "JSESSIONID", sessionid,
</p><p><a href="#L348">348</a>				request.getContextPath() + "/", null, request.isSecure(), true);
</p><p><a href="#L349">349</a>	}
</p><p><a href="#L350">350</a>
</p><p><a href="#L351">351</a>	private void locales(MockHttpServletRequest request) {
</p><p><a href="#L352">352</a>		String locale = header("Accept-Language");
</p><p><a href="#L353">353</a>		if (locale == null) {
</p><p><a href="#L354">354</a>			request.addPreferredLocale(Locale.getDefault());
</p><p><a href="#L355">355</a>		}
</p><p><a href="#L356">356</a>	}
</p><p><a href="#L357">357</a>
</p><p><a href="#L358">358</a>	private void params(MockHttpServletRequest request, UriComponents uriComponents) {
</p><p><a href="#L359">359</a>		uriComponents.getQueryParams().forEach((name, values) -&gt; {
</p><p><a href="#L360">360</a>			String urlDecodedName = urlDecode(name);
</p><p><a href="#L361">361</a>			values.forEach(value -&gt; {
</p><p><a href="#L362">362</a>				value = (value != null ? urlDecode(value) : "");
</p><p><a href="#L363">363</a>				request.addParameter(urlDecodedName, value);
</p><p><a href="#L364">364</a>			});
</p><p><a href="#L365">365</a>		});
</p><p><a href="#L366">366</a>		for (NameValuePair param : this.webRequest.getRequestParameters()) {
</p><p><a href="#L367">367</a>			request.addParameter(param.getName(), param.getValue());
</p><p><a href="#L368">368</a>		}
</p><p><a href="#L369">369</a>	}
</p><p><a href="#L370">370</a>
</p><p><a href="#L371">371</a>	private String urlDecode(String value) {
</p><p><a href="#L372">372</a>		try {
</p><p><a href="#L373">373</a>			return URLDecoder.decode(value, "UTF-8");
</p><p><a href="#L374">374</a>		}
</p><p><a href="#L375">375</a>		catch (UnsupportedEncodingException ex) {
</p><p><a href="#L376">376</a>			throw new IllegalStateException(ex);
</p><p><a href="#L377">377</a>		}
</p><p><a href="#L378">378</a>	}
</p><p><a href="#L379">379</a>
</p><p><a href="#L380">380</a>	private void servletPath(MockHttpServletRequest request, String requestPath) {
</p><p><a href="#L381">381</a>		String servletPath = requestPath.substring(request.getContextPath().length());
</p><p><a href="#L382">382</a>		request.setServletPath(servletPath);
</p><p><a href="#L383">383</a>	}
</p><p><a href="#L384">384</a>
</p><p><a href="#L385">385</a>	private void servletPath(UriComponents uriComponents, MockHttpServletRequest request) {
</p><p><a href="#L386">386</a>		if ("".equals(request.getPathInfo())) {
</p><p><a href="#L387">387</a>			request.setPathInfo(null);
</p><p><a href="#L388">388</a>		}
</p><p><a href="#L389">389</a>		String path = uriComponents.getPath();
</p><p><a href="#L390">390</a>		servletPath(request, (path != null ? path : ""));
</p><p><a href="#L391">391</a>	}
</p><p><a href="#L392">392</a>
</p><p><a href="#L393">393</a>	private void ports(UriComponents uriComponents, MockHttpServletRequest request) {
</p><p><a href="#L394">394</a>		int serverPort = uriComponents.getPort();
</p><p><a href="#L395">395</a>		request.setServerPort(serverPort);
</p><p><a href="#L396">396</a>		if (serverPort == -1) {
</p><p><a href="#L397">397</a>			int portConnection = this.webRequest.getUrl().getDefaultPort();
</p><p><a href="#L398">398</a>			request.setLocalPort(serverPort);
</p><p><a href="#L399">399</a>			request.setRemotePort(portConnection);
</p><p><a href="#L400">400</a>		}
</p><p><a href="#L401">401</a>		else {
</p><p><a href="#L402">402</a>			request.setRemotePort(serverPort);
</p><p><a href="#L403">403</a>		}
</p><p><a href="#L404">404</a>	}
</p><p><a href="#L405">405</a>
</p><p><a href="#L406">406</a>	private UriComponents uriComponents() {
</p><p><a href="#L407">407</a>		URL url = this.webRequest.getUrl();
</p><p><a href="#L408">408</a>		return UriComponentsBuilder.fromUriString(url.toExternalForm()).build();
</p><p><a href="#L409">409</a>	}
</p><p><a href="#L410">410</a>
</p><p><a href="#L411">411</a>	@Override
</p><p><a href="#L412">412</a>	public boolean isMergeEnabled() {
</p><p><a href="#L413">413</a>		return true;
</p><p><a href="#L414">414</a>	}
</p><p><a href="#L415">415</a>
</p><p><a href="#L416">416</a>	@Override
</p><p><a href="#L417">417</a>	public Object merge(@Nullable Object parent) {
</p><p><a href="#L418">418</a>		if (parent instanceof RequestBuilder) {
</p><p><a href="#L419">419</a>			if (parent instanceof MockHttpServletRequestBuilder) {
</p><p><a href="#L420">420</a>				MockHttpServletRequestBuilder copiedParent = MockMvcRequestBuilders.get("/");
</p><p><a href="#L421">421</a>				copiedParent.merge(parent);
</p><p><a href="#L422">422</a>				this.parentBuilder = copiedParent;
</p><p><a href="#L423">423</a>			}
</p><p><a href="#L424">424</a>			else {
</p><p><a href="#L425">425</a>				this.parentBuilder = (RequestBuilder) parent;
</p><p><a href="#L426">426</a>			}
</p><p><a href="#L427">427</a>			if (parent instanceof SmartRequestBuilder) {
</p><p><a href="#L428">428</a>				this.parentPostProcessor = (SmartRequestBuilder) parent;
</p><p><a href="#L429">429</a>			}
</p><p><a href="#L430">430</a>		}
</p><p><a href="#L431">431</a>		return this;
</p><p><a href="#L432">432</a>	}
</p><p><a href="#L433">433</a>
</p><p><a href="#L434">434</a>	private CookieManager getCookieManager() {
</p><p><a href="#L435">435</a>		return this.webClient.getCookieManager();
</p><p><a href="#L436">436</a>	}
</p><p><a href="#L437">437</a>
</p><p><a href="#L438">438</a>
</p><p><a href="#L439">439</a>	/**
</p><p><a href="#L440">440</a>	 * An extension to {@link MockHttpServletRequest} that ensures that when a
</p><p><a href="#L441">441</a>	 * new {@link HttpSession} is created, it is added to the managed sessions.
</p><p><a href="#L442">442</a>	 */
</p><p><a href="#L443">443</a>	private final class HtmlUnitMockHttpServletRequest extends MockHttpServletRequest {
</p><p><a href="#L444">444</a>
</p><p><a href="#L445">445</a>		public HtmlUnitMockHttpServletRequest(ServletContext servletContext, String method, String requestURI) {
</p><p><a href="#L446">446</a>			super(servletContext, method, requestURI);
</p><p><a href="#L447">447</a>		}
</p><p><a href="#L448">448</a>
</p><p><a href="#L449">449</a>		@Override
</p><p><a href="#L450">450</a>		public HttpSession getSession(boolean create) {
</p><p><a href="#L451">451</a>			HttpSession session = super.getSession(false);
</p><p><a href="#L452">452</a>			if (session == null &amp;&amp; create) {
</p><p><a href="#L453">453</a>				HtmlUnitMockHttpSession newSession = new HtmlUnitMockHttpSession(this);
</p><p><a href="#L454">454</a>				setSession(newSession);
</p><p><a href="#L455">455</a>				newSession.setNew(true);
</p><p><a href="#L456">456</a>				String sessionid = newSession.getId();
</p><p><a href="#L457">457</a>				synchronized (HtmlUnitRequestBuilder.this.sessions) {
</p><p><a href="#L458">458</a>					HtmlUnitRequestBuilder.this.sessions.put(sessionid, newSession);
</p><p><a href="#L459">459</a>				}
</p><p><a href="#L460">460</a>				addSessionCookie(this, sessionid);
</p><p><a href="#L461">461</a>				session = newSession;
</p><p><a href="#L462">462</a>			}
</p><p><a href="#L463">463</a>			return session;
</p><p><a href="#L464">464</a>		}
</p><p><a href="#L465">465</a>	}
</p><p><a href="#L466">466</a>
</p><p><a href="#L467">467</a>
</p><p><a href="#L468">468</a>	/**
</p><p><a href="#L469">469</a>	 * An extension to {@link MockHttpSession} that ensures when
</p><p><a href="#L470">470</a>	 * {@link #invalidate()} is called that the {@link HttpSession}
</p><p><a href="#L471">471</a>	 * is removed from the managed sessions.
</p><p><a href="#L472">472</a>	 */
</p><p><a href="#L473">473</a>	private final class HtmlUnitMockHttpSession extends MockHttpSession {
</p><p><a href="#L474">474</a>
</p><p><a href="#L475">475</a>		private final MockHttpServletRequest request;
</p><p><a href="#L476">476</a>
</p><p><a href="#L477">477</a>		public HtmlUnitMockHttpSession(MockHttpServletRequest request) {
</p><p><a href="#L478">478</a>			super(request.getServletContext());
</p><p><a href="#L479">479</a>			this.request = request;
</p><p><a href="#L480">480</a>		}
</p><p><a href="#L481">481</a>
</p><p><a href="#L482">482</a>		private HtmlUnitMockHttpSession(MockHttpServletRequest request, String id) {
</p><p><a href="#L483">483</a>			super(request.getServletContext(), id);
</p><p><a href="#L484">484</a>			this.request = request;
</p><p><a href="#L485">485</a>		}
</p><p><a href="#L486">486</a>
</p><p><a href="#L487">487</a>		@Override
</p><p><a href="#L488">488</a>		public void invalidate() {
</p><p><a href="#L489">489</a>			super.invalidate();
</p><p><a href="#L490">490</a>			synchronized (HtmlUnitRequestBuilder.this.sessions) {
</p><p><a href="#L491">491</a>				HtmlUnitRequestBuilder.this.sessions.remove(getId());
</p><p><a href="#L492">492</a>			}
</p><p><a href="#L493">493</a>			removeSessionCookie(request, getId());
</p><p><a href="#L494">494</a>		}
</p><p><a href="#L495">495</a>	}
</p><p><a href="#L496">496</a>
</p><p><a href="#L497">497</a>}
</p></pre></body></html>

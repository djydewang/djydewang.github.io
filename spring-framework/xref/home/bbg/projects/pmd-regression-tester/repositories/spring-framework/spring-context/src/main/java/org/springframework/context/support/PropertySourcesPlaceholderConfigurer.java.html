<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><pre><p><a href="#L1">1</a>/*
</p><p><a href="#L2">2</a> * Copyright 2002-2018 the original author or authors.
</p><p><a href="#L3">3</a> *
</p><p><a href="#L4">4</a> * Licensed under the Apache License, Version 2.0 (the "License");
</p><p><a href="#L5">5</a> * you may not use this file except in compliance with the License.
</p><p><a href="#L6">6</a> * You may obtain a copy of the License at
</p><p><a href="#L7">7</a> *
</p><p><a href="#L8">8</a> *      http://www.apache.org/licenses/LICENSE-2.0
</p><p><a href="#L9">9</a> *
</p><p><a href="#L10">10</a> * Unless required by applicable law or agreed to in writing, software
</p><p><a href="#L11">11</a> * distributed under the License is distributed on an "AS IS" BASIS,
</p><p><a href="#L12">12</a> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</p><p><a href="#L13">13</a> * See the License for the specific language governing permissions and
</p><p><a href="#L14">14</a> * limitations under the License.
</p><p><a href="#L15">15</a> */
</p><p><a href="#L16">16</a>
</p><p><a href="#L17">17</a>package org.springframework.context.support;
</p><p><a href="#L18">18</a>
</p><p><a href="#L19">19</a>import java.io.IOException;
</p><p><a href="#L20">20</a>import java.util.Properties;
</p><p><a href="#L21">21</a>
</p><p><a href="#L22">22</a>import org.springframework.beans.BeansException;
</p><p><a href="#L23">23</a>import org.springframework.beans.factory.BeanInitializationException;
</p><p><a href="#L24">24</a>import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;
</p><p><a href="#L25">25</a>import org.springframework.beans.factory.config.PlaceholderConfigurerSupport;
</p><p><a href="#L26">26</a>import org.springframework.context.EnvironmentAware;
</p><p><a href="#L27">27</a>import org.springframework.core.env.ConfigurablePropertyResolver;
</p><p><a href="#L28">28</a>import org.springframework.core.env.Environment;
</p><p><a href="#L29">29</a>import org.springframework.core.env.MutablePropertySources;
</p><p><a href="#L30">30</a>import org.springframework.core.env.PropertiesPropertySource;
</p><p><a href="#L31">31</a>import org.springframework.core.env.PropertySource;
</p><p><a href="#L32">32</a>import org.springframework.core.env.PropertySources;
</p><p><a href="#L33">33</a>import org.springframework.core.env.PropertySourcesPropertyResolver;
</p><p><a href="#L34">34</a>import org.springframework.lang.Nullable;
</p><p><a href="#L35">35</a>import org.springframework.util.Assert;
</p><p><a href="#L36">36</a>import org.springframework.util.StringValueResolver;
</p><p><a href="#L37">37</a>
</p><p><a href="#L38">38</a>/**
</p><p><a href="#L39">39</a> * Specialization of {@link PlaceholderConfigurerSupport} that resolves ${...} placeholders
</p><p><a href="#L40">40</a> * within bean definition property values and {@code @Value} annotations against the current
</p><p><a href="#L41">41</a> * Spring {@link Environment} and its set of {@link PropertySources}.
</p><p><a href="#L42">42</a> *
</p><p><a href="#L43">43</a> * &lt;p&gt;This class is designed as a general replacement for {@code PropertyPlaceholderConfigurer}
</p><p><a href="#L44">44</a> * in Spring 3.1 applications. It is used by default to support the {@code property-placeholder}
</p><p><a href="#L45">45</a> * element in working against the spring-context-3.1 XSD, whereas spring-context versions
</p><p><a href="#L46">46</a> * &amp;lt;= 3.0 default to {@code PropertyPlaceholderConfigurer} to ensure backward compatibility.
</p><p><a href="#L47">47</a> * See the spring-context XSD documentation for complete details.
</p><p><a href="#L48">48</a> *
</p><p><a href="#L49">49</a> * &lt;p&gt;Any local properties (e.g. those added via {@link #setProperties}, {@link #setLocations}
</p><p><a href="#L50">50</a> * et al.) are added as a {@code PropertySource}. Search precedence of local properties is
</p><p><a href="#L51">51</a> * based on the value of the {@link #setLocalOverride localOverride} property, which is by
</p><p><a href="#L52">52</a> * default {@code false} meaning that local properties are to be searched last, after all
</p><p><a href="#L53">53</a> * environment property sources.
</p><p><a href="#L54">54</a> *
</p><p><a href="#L55">55</a> * &lt;p&gt;See {@link org.springframework.core.env.ConfigurableEnvironment ConfigurableEnvironment}
</p><p><a href="#L56">56</a> * and related javadocs for details on manipulating environment property sources.
</p><p><a href="#L57">57</a> *
</p><p><a href="#L58">58</a> * @author Chris Beams
</p><p><a href="#L59">59</a> * @since 3.1
</p><p><a href="#L60">60</a> * @see org.springframework.core.env.ConfigurableEnvironment
</p><p><a href="#L61">61</a> * @see org.springframework.beans.factory.config.PlaceholderConfigurerSupport
</p><p><a href="#L62">62</a> * @see org.springframework.beans.factory.config.PropertyPlaceholderConfigurer
</p><p><a href="#L63">63</a> */
</p><p><a href="#L64">64</a>public class PropertySourcesPlaceholderConfigurer extends PlaceholderConfigurerSupport implements EnvironmentAware {
</p><p><a href="#L65">65</a>
</p><p><a href="#L66">66</a>	/**
</p><p><a href="#L67">67</a>	 * {@value} is the name given to the {@link PropertySource} for the set of
</p><p><a href="#L68">68</a>	 * {@linkplain #mergeProperties() merged properties} supplied to this configurer.
</p><p><a href="#L69">69</a>	 */
</p><p><a href="#L70">70</a>	public static final String LOCAL_PROPERTIES_PROPERTY_SOURCE_NAME = "localProperties";
</p><p><a href="#L71">71</a>
</p><p><a href="#L72">72</a>	/**
</p><p><a href="#L73">73</a>	 * {@value} is the name given to the {@link PropertySource} that wraps the
</p><p><a href="#L74">74</a>	 * {@linkplain #setEnvironment environment} supplied to this configurer.
</p><p><a href="#L75">75</a>	 */
</p><p><a href="#L76">76</a>	public static final String ENVIRONMENT_PROPERTIES_PROPERTY_SOURCE_NAME = "environmentProperties";
</p><p><a href="#L77">77</a>
</p><p><a href="#L78">78</a>
</p><p><a href="#L79">79</a>	@Nullable
</p><p><a href="#L80">80</a>	private MutablePropertySources propertySources;
</p><p><a href="#L81">81</a>
</p><p><a href="#L82">82</a>	@Nullable
</p><p><a href="#L83">83</a>	private PropertySources appliedPropertySources;
</p><p><a href="#L84">84</a>
</p><p><a href="#L85">85</a>	@Nullable
</p><p><a href="#L86">86</a>	private Environment environment;
</p><p><a href="#L87">87</a>
</p><p><a href="#L88">88</a>
</p><p><a href="#L89">89</a>	/**
</p><p><a href="#L90">90</a>	 * Customize the set of {@link PropertySources} to be used by this configurer.
</p><p><a href="#L91">91</a>	 * Setting this property indicates that environment property sources and local
</p><p><a href="#L92">92</a>	 * properties should be ignored.
</p><p><a href="#L93">93</a>	 * @see #postProcessBeanFactory
</p><p><a href="#L94">94</a>	 */
</p><p><a href="#L95">95</a>	public void setPropertySources(PropertySources propertySources) {
</p><p><a href="#L96">96</a>		this.propertySources = new MutablePropertySources(propertySources);
</p><p><a href="#L97">97</a>	}
</p><p><a href="#L98">98</a>
</p><p><a href="#L99">99</a>	/**
</p><p><a href="#L100">100</a>	 * {@inheritDoc}
</p><p><a href="#L101">101</a>	 * &lt;p&gt;{@code PropertySources} from this environment will be searched when replacing ${...} placeholders.
</p><p><a href="#L102">102</a>	 * @see #setPropertySources
</p><p><a href="#L103">103</a>	 * @see #postProcessBeanFactory
</p><p><a href="#L104">104</a>	 */
</p><p><a href="#L105">105</a>	@Override
</p><p><a href="#L106">106</a>	public void setEnvironment(Environment environment) {
</p><p><a href="#L107">107</a>		this.environment = environment;
</p><p><a href="#L108">108</a>	}
</p><p><a href="#L109">109</a>
</p><p><a href="#L110">110</a>
</p><p><a href="#L111">111</a>	/**
</p><p><a href="#L112">112</a>	 * {@inheritDoc}
</p><p><a href="#L113">113</a>	 * &lt;p&gt;Processing occurs by replacing ${...} placeholders in bean definitions by resolving each
</p><p><a href="#L114">114</a>	 * against this configurer's set of {@link PropertySources}, which includes:
</p><p><a href="#L115">115</a>	 * &lt;ul&gt;
</p><p><a href="#L116">116</a>	 * &lt;li&gt;all {@linkplain org.springframework.core.env.ConfigurableEnvironment#getPropertySources
</p><p><a href="#L117">117</a>	 * environment property sources}, if an {@code Environment} {@linkplain #setEnvironment is present}
</p><p><a href="#L118">118</a>	 * &lt;li&gt;{@linkplain #mergeProperties merged local properties}, if {@linkplain #setLocation any}
</p><p><a href="#L119">119</a>	 * {@linkplain #setLocations have} {@linkplain #setProperties been}
</p><p><a href="#L120">120</a>	 * {@linkplain #setPropertiesArray specified}
</p><p><a href="#L121">121</a>	 * &lt;li&gt;any property sources set by calling {@link #setPropertySources}
</p><p><a href="#L122">122</a>	 * &lt;/ul&gt;
</p><p><a href="#L123">123</a>	 * &lt;p&gt;If {@link #setPropertySources} is called, &lt;strong&gt;environment and local properties will be
</p><p><a href="#L124">124</a>	 * ignored&lt;/strong&gt;. This method is designed to give the user fine-grained control over property
</p><p><a href="#L125">125</a>	 * sources, and once set, the configurer makes no assumptions about adding additional sources.
</p><p><a href="#L126">126</a>	 */
</p><p><a href="#L127">127</a>	@Override
</p><p><a href="#L128">128</a>	public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException {
</p><p><a href="#L129">129</a>		if (this.propertySources == null) {
</p><p><a href="#L130">130</a>			this.propertySources = new MutablePropertySources();
</p><p><a href="#L131">131</a>			if (this.environment != null) {
</p><p><a href="#L132">132</a>				this.propertySources.addLast(
</p><p><a href="#L133">133</a>					new PropertySource&lt;Environment&gt;(ENVIRONMENT_PROPERTIES_PROPERTY_SOURCE_NAME, this.environment) {
</p><p><a href="#L134">134</a>						@Override
</p><p><a href="#L135">135</a>						@Nullable
</p><p><a href="#L136">136</a>						public String getProperty(String key) {
</p><p><a href="#L137">137</a>							return this.source.getProperty(key);
</p><p><a href="#L138">138</a>						}
</p><p><a href="#L139">139</a>					}
</p><p><a href="#L140">140</a>				);
</p><p><a href="#L141">141</a>			}
</p><p><a href="#L142">142</a>			try {
</p><p><a href="#L143">143</a>				PropertySource&lt;?&gt; localPropertySource =
</p><p><a href="#L144">144</a>						new PropertiesPropertySource(LOCAL_PROPERTIES_PROPERTY_SOURCE_NAME, mergeProperties());
</p><p><a href="#L145">145</a>				if (this.localOverride) {
</p><p><a href="#L146">146</a>					this.propertySources.addFirst(localPropertySource);
</p><p><a href="#L147">147</a>				}
</p><p><a href="#L148">148</a>				else {
</p><p><a href="#L149">149</a>					this.propertySources.addLast(localPropertySource);
</p><p><a href="#L150">150</a>				}
</p><p><a href="#L151">151</a>			}
</p><p><a href="#L152">152</a>			catch (IOException ex) {
</p><p><a href="#L153">153</a>				throw new BeanInitializationException("Could not load properties", ex);
</p><p><a href="#L154">154</a>			}
</p><p><a href="#L155">155</a>		}
</p><p><a href="#L156">156</a>
</p><p><a href="#L157">157</a>		processProperties(beanFactory, new PropertySourcesPropertyResolver(this.propertySources));
</p><p><a href="#L158">158</a>		this.appliedPropertySources = this.propertySources;
</p><p><a href="#L159">159</a>	}
</p><p><a href="#L160">160</a>
</p><p><a href="#L161">161</a>	/**
</p><p><a href="#L162">162</a>	 * Visit each bean definition in the given bean factory and attempt to replace ${...} property
</p><p><a href="#L163">163</a>	 * placeholders with values from the given properties.
</p><p><a href="#L164">164</a>	 */
</p><p><a href="#L165">165</a>	protected void processProperties(ConfigurableListableBeanFactory beanFactoryToProcess,
</p><p><a href="#L166">166</a>			final ConfigurablePropertyResolver propertyResolver) throws BeansException {
</p><p><a href="#L167">167</a>
</p><p><a href="#L168">168</a>		propertyResolver.setPlaceholderPrefix(this.placeholderPrefix);
</p><p><a href="#L169">169</a>		propertyResolver.setPlaceholderSuffix(this.placeholderSuffix);
</p><p><a href="#L170">170</a>		propertyResolver.setValueSeparator(this.valueSeparator);
</p><p><a href="#L171">171</a>
</p><p><a href="#L172">172</a>		StringValueResolver valueResolver = strVal -&gt; {
</p><p><a href="#L173">173</a>			String resolved = (ignoreUnresolvablePlaceholders ?
</p><p><a href="#L174">174</a>					propertyResolver.resolvePlaceholders(strVal) :
</p><p><a href="#L175">175</a>					propertyResolver.resolveRequiredPlaceholders(strVal));
</p><p><a href="#L176">176</a>			if (trimValues) {
</p><p><a href="#L177">177</a>				resolved = resolved.trim();
</p><p><a href="#L178">178</a>			}
</p><p><a href="#L179">179</a>			return (resolved.equals(nullValue) ? null : resolved);
</p><p><a href="#L180">180</a>		};
</p><p><a href="#L181">181</a>
</p><p><a href="#L182">182</a>		doProcessProperties(beanFactoryToProcess, valueResolver);
</p><p><a href="#L183">183</a>	}
</p><p><a href="#L184">184</a>
</p><p><a href="#L185">185</a>	/**
</p><p><a href="#L186">186</a>	 * Implemented for compatibility with {@link org.springframework.beans.factory.config.PlaceholderConfigurerSupport}.
</p><p><a href="#L187">187</a>	 * @deprecated in favor of {@link #processProperties(ConfigurableListableBeanFactory, ConfigurablePropertyResolver)}
</p><p><a href="#L188">188</a>	 * @throws UnsupportedOperationException in this implementation
</p><p><a href="#L189">189</a>	 */
</p><p><a href="#L190">190</a>	@Override
</p><p><a href="#L191">191</a>	@Deprecated
</p><p><a href="#L192">192</a>	protected void processProperties(ConfigurableListableBeanFactory beanFactory, Properties props) {
</p><p><a href="#L193">193</a>		throw new UnsupportedOperationException(
</p><p><a href="#L194">194</a>				"Call processProperties(ConfigurableListableBeanFactory, ConfigurablePropertyResolver) instead");
</p><p><a href="#L195">195</a>	}
</p><p><a href="#L196">196</a>
</p><p><a href="#L197">197</a>	/**
</p><p><a href="#L198">198</a>	 * Returns the property sources that were actually applied during
</p><p><a href="#L199">199</a>	 * {@link #postProcessBeanFactory(ConfigurableListableBeanFactory) post-processing}.
</p><p><a href="#L200">200</a>	 * @return the property sources that were applied
</p><p><a href="#L201">201</a>	 * @throws IllegalStateException if the property sources have not yet been applied
</p><p><a href="#L202">202</a>	 * @since 4.0
</p><p><a href="#L203">203</a>	 */
</p><p><a href="#L204">204</a>	public PropertySources getAppliedPropertySources() throws IllegalStateException {
</p><p><a href="#L205">205</a>		Assert.state(this.appliedPropertySources != null, "PropertySources have not get been applied");
</p><p><a href="#L206">206</a>		return this.appliedPropertySources;
</p><p><a href="#L207">207</a>	}
</p><p><a href="#L208">208</a>
</p><p><a href="#L209">209</a>}
</p></pre></body></html>
